name: Cleanup Old Fly.io Images

on:
  schedule:
    # Run weekly on Sunday at midnight UTC
    - cron: '0 0 * * 0'
  workflow_dispatch:  # Allow manual trigger from GitHub UI

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Fly.io CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Clean up old releases
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          echo "Fetching all releases for caf-gpt..."

          # Keep only the last 10 releases, delete older ones
          KEEP_COUNT=10

          # Get all release versions, skip header, keep only versions older than KEEP_COUNT
          fly releases -a caf-gpt | tail -n +2 | awk '{print $1}' | tail -n +$((KEEP_COUNT + 1)) | \
          while read version; do
            if [[ $version =~ ^v[0-9]+$ ]]; then
              echo "Deleting release $version..."
              fly releases delete $version -a caf-gpt --yes || echo "Failed to delete $version (may already be deleted)"
            fi
          done

          echo "Cleanup complete! Kept the last $KEEP_COUNT releases."
